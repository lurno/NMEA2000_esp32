--- NMEA2000_esp32.cpp	2024-11-30 16:17:42.776168989 +0100
+++ /home/lasse/Arduino/libraries/NMEA2000_esp32/NMEA2000_esp32.cpp	2024-11-27 16:30:43.877358097 +0100
@@ -121,16 +121,33 @@
 
   // A soft reset of the ESP32 leaves it's CAN controller in an undefined state so a reset is needed.
   // Reset CAN controller to same state as it would be in after a power down reset.
-  periph_module_reset(PERIPH_CAN_MODULE);
-
+  //
+#if defined CONFIG_IDF_TARGET_ESP32S2 || defined CONFIG_IDF_TARGET_ESP32S3
+	periph_module_reset(PERIPH_USB_MODULE);
+#else
+	periph_module_reset(PERIPH_CAN_MODULE);
+#endif
 
     //enable module
+#if defined CONFIG_IDF_TARGET_ESP32S3
+  DPORT_SET_PERI_REG_MASK(SYSTEM_PERIP_CLK_EN1_REG, SYSTEM_USB_CLK_EN);
+  DPORT_CLEAR_PERI_REG_MASK(SYSTEM_PERIP_RST_EN1_REG, SYSTEM_USB_RST);
+#elif defined CONFIG_IDF_TARGET_ESP32S2
+  DPORT_SET_PERI_REG_MASK(DPORT_PERIP_CLK_EN1_REG, DPORT_USB_CLK_EN);
+  DPORT_CLEAR_PERI_REG_MASK(DPORT_PERIP_RST_EN1_REG, DPORT_USB_RST);
+#else
   DPORT_SET_PERI_REG_MASK(DPORT_PERIP_CLK_EN_REG, DPORT_CAN_CLK_EN);
   DPORT_CLEAR_PERI_REG_MASK(DPORT_PERIP_RST_EN_REG, DPORT_CAN_RST);
+#endif
+
 
     //configure RX pin
 	gpio_set_direction(RxPin,GPIO_MODE_INPUT);
+#if defined CONFIG_IDF_TARGET_ESP32S2 || defined CONFIG_IDF_TARGET_ESP32S3
+	gpio_matrix_in(RxPin,TWAI_RX_IDX,0);
+#else
 	gpio_matrix_in(RxPin,CAN_RX_IDX,0);
+#endif
 	gpio_pad_select_gpio(RxPin);
 
     //set to PELICAN mode
@@ -191,14 +208,22 @@
     (void)MODULE_CAN->IR.U;
 
     //install CAN ISR
+#if defined CONFIG_IDF_TARGET_ESP32S2 || defined CONFIG_IDF_TARGET_ESP32S3
+    esp_intr_alloc(ETS_MAX_INTR_SOURCE,0,ESP32Can1Interrupt,NULL,NULL);
+#else
     esp_intr_alloc(ETS_CAN_INTR_SOURCE,0,ESP32Can1Interrupt,NULL,NULL);
+#endif
 
     //configure TX pin
     // We do late configure, since some initialization above caused CAN Tx flash
     // shortly causing one error frame on startup. By setting CAN pin here
     // it works right.
     gpio_set_direction(TxPin,GPIO_MODE_OUTPUT);
+#if defined CONFIG_IDF_TARGET_ESP32S2 || defined CONFIG_IDF_TARGET_ESP32S3
+    gpio_matrix_out(TxPin,TWAI_TX_IDX,0,0);
+#else
     gpio_matrix_out(TxPin,CAN_TX_IDX,0,0);
+#endif
     gpio_pad_select_gpio(TxPin);
 
     //Showtime. Release Reset Mode.
